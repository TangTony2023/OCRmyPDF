name: PDF OCR Processor

on:
  push:
    paths:
      - 'pdf-input/**'  # ç›‘æ§pdf-inputç›®å½•ä¸‹çš„æ–‡ä»¶å˜åŒ–
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      filename:
        description: 'PDFæ–‡ä»¶å (å¦‚ document.pdf)'
        required: true
      languages:
        description: 'OCRè¯­è¨€ä»£ç  (å¦‚ eng+chi_sim)'
        required: false
        default: 'eng'

jobs:
  ocr-process:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ocrmypdf/ocrmypdf:latest
      options: --user root  # éœ€è¦rootæƒé™å®‰è£…è¯­è¨€åŒ…

    steps:
    # ========== å‡†å¤‡é˜¶æ®µ ==========
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: å®‰è£…è¯­è¨€åŒ…
      run: |
        apt-get update
        # åŸºç¡€è¯­è¨€åŒ…ï¼ˆè‹±è¯­å·²åŒ…å«ï¼‰
        apt-get install -y \
          tesseract-ocr-chi-sim \  # ç®€ä½“ä¸­æ–‡
          tesseract-ocr-chi-tra \  # ç¹ä½“ä¸­æ–‡
          tesseract-ocr-jpn        # æ—¥è¯­
        # æ·»åŠ å…¶ä»–éœ€è¦çš„è¯­è¨€åŒ…...

    # ========== å¤„ç†é˜¶æ®µ ==========
    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: mkdir -p pdf-output

    - name: æ‰§è¡ŒOCRå¤„ç†
      id: ocr
      run: |
        INPUT_FILE="pdf-input/${{ github.event.inputs.filename || 'document.pdf' }}"
        OUTPUT_FILE="pdf-output/$(basename "${INPUT_FILE%.*}")_OCR.pdf"
        
        ocrmypdf \
          "$INPUT_FILE" \
          "$OUTPUT_FILE" \
          --language "${{ github.event.inputs.languages || 'eng' }}" \
          --output-type pdfa \
          --deskew \          # è‡ªåŠ¨çŸ«æ­£å€¾æ–œ
          --clean \           # æ¸…ç†æ‰«æä¼ªå½±
          --optimize 3 \      # æœ€é«˜çº§åˆ«ä¼˜åŒ–
          --progress-bar
        
        # è¾“å‡ºå¤„ç†ç»“æœè·¯å¾„
        echo "output_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
        echo "input_path=$INPUT_FILE" >> $GITHUB_OUTPUT

    # ========== ç»“æœå¤„ç† ==========
    - name: ä¸Šä¼ ç»“æœæ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: ocr-result
        path: ${{ steps.ocr.outputs.output_path }}

    - name: ç”Ÿæˆå¤„ç†æŠ¥å‘Š
      run: |
        echo "ğŸ“Š OCRå¤„ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- è¾“å…¥æ–‡ä»¶: [${{ steps.ocr.outputs.input_path }}](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${{ steps.ocr.outputs.input_path }})" >> $GITHUB_STEP_SUMMARY
        echo "- è¾“å‡ºæ–‡ä»¶: [${{ steps.ocr.outputs.output_path }}](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${{ steps.ocr.outputs.output_path }})" >> $GITHUB_STEP_SUMMARY
        echo "- æ–‡ä»¶å¤§å°å˜åŒ–: $(du -h ${{ steps.ocr.outputs.input_path }} | cut -f1) â†’ $(du -h ${{ steps.ocr.outputs.output_path }} | cut -f1)" >> $GITHUB_STEP_SUMMARY

    # ========== é€šçŸ¥é˜¶æ®µ ========== (å¯é€‰)
    - name: å‘é€Slacké€šçŸ¥
      if: success()
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "âœ… PDFå¤„ç†å®Œæˆ: ${{ github.event.inputs.filename || 'document.pdf' }}",
            "attachments": [{
              "fields": [
                {
                  "title": "ä¸‹è½½é“¾æ¥",
                  "value": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
